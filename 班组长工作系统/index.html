<!DOCTYPE html>
<html lang="zh-CN">
<head>
<!-- 引入SheetJS库用于生成Excel文件 -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>生产任务管理系统</title>
    <!-- 引入外部资源 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    
    <!-- Tailwind配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',
                        secondary: '#36CFC9',
                        success: '#52C41A',
                        warning: '#FAAD14',
                        danger: '#FF4D4F',
                        gray: {
                            100: '#F5F5F5',
                            200: '#E5E5E5',
                            300: '#D4D4D4',
                            400: '#A3A3A3',
                            500: '#737373',
                            600: '#525252',
                            700: '#404040',
                            800: '#262626',
                            900: '#171717',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <!-- 自定义工具类 -->
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .card-shadow {
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            }
            .btn-primary {
                @apply bg-primary text-white px-4 py-2 rounded-md hover:bg-primary/90 transition-all duration-200;
            }
            .btn-secondary {
                @apply bg-white text-primary border border-primary px-4 py-2 rounded-md hover:bg-gray-100 transition-all duration-200;
            }
            .input-field {
                @apply border border-gray-300 rounded-md px-3 py-2 w-full focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary;
            }
            .task-card {
                @apply bg-white rounded-lg p-4 mb-3 card-shadow transition-all duration-200 hover:shadow-lg;
            }
        }
    </style>
    
    <!-- 添加到桌面的配置 -->
    <link rel="manifest" href="manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="生产任务管理">
    <link rel="apple-touch-icon" href="icon.png">
    <meta name="theme-color" content="#165DFF">
</head>
<body class="bg-gray-100 min-h-screen font-sans">
    <div id="app" class="max-w-4xl mx-auto">
        <!-- 登录界面 -->
        <div id="login-page" class="py-10 px-4">
            <div class="max-w-md mx-auto bg-white rounded-xl p-6 card-shadow">
                <div class="text-center mb-6">
                    <h1 class="text-[clamp(1.5rem,3vw,2rem)] font-bold text-gray-800">生产任务管理系统</h1>
                    <p class="text-gray-500 mt-2">请输入用户名登录</p>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-gray-700 mb-1 text-sm">用户名</label>
                        <input type="text" id="username" class="input-field" placeholder="请输入用户名">
                    </div>
                    
                    <div class="pt-2">
                        <button id="login-btn" class="btn-primary w-full">
                            <i class="fa fa-sign-in mr-1"></i> 登录
                        </button>
                    </div>
                </div>
                
                <!-- 账户管理按钮（仅首次登录或管理员可见） -->
                <div class="mt-4 text-center">
                    <button id="manage-accounts-btn" class="text-primary text-sm hover:underline">
                        <i class="fa fa-cog mr-1"></i> 账户管理
                    </button>
                </div>
            </div>
        </div>
        
        <!-- 主界面 (初始隐藏) -->
        <div id="main-page" class="hidden">
            <!-- 顶部导航 -->
            <header class="bg-white shadow-sm sticky top-0 z-10">
                <div class="container mx-auto px-4 py-3 flex justify-between items-center">
                    <div class="flex items-center">
                        <h1 class="text-xl font-bold text-gray-800">生产任务管理</h1>
                    </div>
                    
                    <div class="flex items-center space-x-3">
                        <button id="refresh-btn" class="p-2 rounded-full hover:bg-gray-100 transition-colors">
                            <i class="fa fa-refresh text-gray-600"></i>
                        </button>
                        <div class="relative">
                            <button id="user-menu-btn" class="flex items-center space-x-2">
                                <img src="https://picsum.photos/id/1005/40/40" alt="用户头像" class="w-8 h-8 rounded-full object-cover">
                                <span id="user-name" class="text-gray-700 hidden sm:inline">管理员</span>
                                <i class="fa fa-angle-down text-gray-500"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </header>
            
            <!-- 内容区域 -->
            <main class="container mx-auto px-4 py-6">
                <!-- 角色切换标签 -->
                <div class="flex border-b border-gray-200 mb-6">
                    <button id="admin-tab" class="px-4 py-2 font-medium text-primary border-b-2 border-primary">管理员视图</button>
                    <button id="leader-tab" class="px-4 py-2 font-medium text-gray-500 hover:text-gray-700">班组长视图</button>
                </div>
                
                <!-- 管理员视图 -->
                <div id="admin-view">
                    <!-- 功能按钮区 -->
                    <div class="flex flex-wrap gap-3 mb-6">
                        <button id="add-process-btn" class="btn-primary">
                            <i class="fa fa-plus mr-1"></i> 添加工序
                        </button>
                        <button id="add-template-btn" class="btn-primary">
                            <i class="fa fa-file-text-o mr-1"></i> 管理任务模板
                        </button>
                        <button id="export-data-btn" class="btn-secondary">
                            <i class="fa fa-download mr-1"></i> 导出数据
                        </button>
                        <button id="wechat-config-btn" class="btn-secondary">
                            <i class="fa fa-weixin mr-1"></i> 企业微信配置
                        </button>
                        <button id="refresh-time-config-btn" class="btn-secondary">
                            <i class="fa fa-clock-o mr-1"></i> 任务刷新时间
                        </button>
                    </div>
                    
                    <!-- 工序列表 -->
                    <div class="bg-white rounded-xl p-5 card-shadow mb-6">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-lg font-semibold text-gray-800">工序管理</h2>
                            <div class="relative">
                                <input type="text" id="process-search" placeholder="搜索工序..." class="input-field pl-9 w-48">
                                <i class="fa fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                            </div>
                        </div>
                        
                        <div id="process-list" class="space-y-3 max-h-[400px] overflow-y-auto pr-2">
                            <!-- 工序列表将通过JS动态生成 -->
                        </div>
                    </div>
                    
                    <!-- 任务模板管理 -->
                    <div class="bg-white rounded-xl p-5 card-shadow">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-lg font-semibold text-gray-800">任务模板</h2>
                            <button id="add-task-to-template-btn" class="btn-primary text-sm px-3 py-1">
                                <i class="fa fa-plus mr-1"></i> 添加任务
                            </button>
                        </div>
                        
                        <div id="template-filters" class="flex flex-wrap gap-2 mb-4">
                            <button class="px-3 py-1 bg-primary text-white rounded-full text-sm">全部工序</button>
                            <!-- 过滤按钮将通过JS动态生成 -->
                        </div>
                        
                        <div id="template-task-list" class="space-y-3 max-h-[400px] overflow-y-auto pr-2">
                            <!-- 任务模板列表将通过JS动态生成 -->
                        </div>
                    </div>
                </div>
                
                <!-- 班组长视图 (初始隐藏) -->
                <div id="leader-view" class="hidden">
                    <!-- 日期和过滤 -->
                    <div class="flex flex-wrap justify-between items-center mb-6 gap-3">
                        <div>
                            <h2 class="text-xl font-bold text-gray-800" id="current-date">2023年6月15日</h2>
                            <p class="text-gray-500" id="current-weekday">星期四</p>
                        </div>
                        
                        <div class="flex gap-2">
                            <div class="relative">
                                <select id="process-filter" class="input-field pr-8">
                                    <option value="all">所有工序</option>
                                    <!-- 选项将通过JS动态生成 -->
                                </select>
                                <i class="fa fa-chevron-down absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 任务列表 -->
                    <div id="leader-task-list" class="space-y-3">
                        <!-- 任务列表将通过JS动态生成 -->
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <!-- 模态框 -->
    <div id="modal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-xl w-full max-w-md max-h-[90vh] overflow-y-auto">
            <div class="p-5 border-b border-gray-200 flex justify-between items-center">
                <h3 id="modal-title" class="text-lg font-semibold text-gray-800">添加工序</h3>
                <button id="close-modal" class="text-gray-500 hover:text-gray-700">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            
            <div id="modal-content" class="p-5 space-y-4">
                <!-- 模态框内容将通过JS动态生成 -->
            </div>
            
            <div class="p-5 border-t border-gray-200 flex justify-end gap-3">
                <button id="cancel-modal" class="btn-secondary">取消</button>
                <button id="confirm-modal" class="btn-primary">确认</button>
            </div>
        </div>
    </div>

    <script>
        // 全局数据存储
        const appData = {
            currentUser: null,
            accounts: [
                { username: 'admin', role: 'admin' } // 默认管理员账户
            ],
            processes: [
                { id: 1, name: "组装", 负责人: "张三", 企业微信账号: "zhangsan@company.com" },
                { id: 2, name: "焊接", 负责人: "李四", 企业微信账号: "lisi@company.com" },
                { id: 3, name: "质检", 负责人: "王五", 企业微信账号: "wangwu@company.com" }
            ],
            taskTemplates: [
                { 
                    id: 1, 
                    processId: 1, 
                    processName: "组装",
                    content: "完成每日产品组装", 
                    deadline: "09:00",
                    reminderTime: "08:30",
                    assignee: "张三",
                    assigneeWechat: "zhangsan@company.com" // 负责人企业微信账号
                },
                { 
                    id: 2, 
                    processId: 2, 
                    processName: "焊接",
                    content: "完成部件焊接工作", 
                    deadline: "11:30",
                    reminderTime: "11:00",
                    assignee: "李四",
                    assigneeWechat: "lisi@company.com"
                },
                { 
                    id: 3, 
                    processId: 3, 
                    processName: "质检",
                    content: "完成上午产品质检", 
                    deadline: "12:00",
                    reminderTime: "11:45",
                    assignee: "王五",
                    assigneeWechat: "wangwu@company.com"
                }
            ],
            todayTasks: [],
            wechatConfig: {
                robotUrl: "",
            },
            refreshTime: "07:30" // 默认每日刷新时间
        };

        // DOM元素
        const elements = {
            loginPage: document.getElementById('login-page'),
            mainPage: document.getElementById('main-page'),
            usernameInput: document.getElementById('username'),
            loginBtn: document.getElementById('login-btn'),
            manageAccountsBtn: document.getElementById('manage-accounts-btn'),
            adminTab: document.getElementById('admin-tab'),
            leaderTab: document.getElementById('leader-tab'),
            adminView: document.getElementById('admin-view'),
            leaderView: document.getElementById('leader-view'),
            processList: document.getElementById('process-list'),
            templateTaskList: document.getElementById('template-task-list'),
            leaderTaskList: document.getElementById('leader-task-list'),
            modal: document.getElementById('modal'),
            modalTitle: document.getElementById('modal-title'),
            modalContent: document.getElementById('modal-content'),
            closeModal: document.getElementById('close-modal'),
            cancelModal: document.getElementById('cancel-modal'),
            confirmModal: document.getElementById('confirm-modal'),
            addProcessBtn: document.getElementById('add-process-btn'),
            addTemplateBtn: document.getElementById('add-template-btn'),
            exportDataBtn: document.getElementById('export-data-btn'),
            wechatConfigBtn: document.getElementById('wechat-config-btn'),
            refreshTimeConfigBtn: document.getElementById('refresh-time-config-btn'),
            addTaskToTemplateBtn: document.getElementById('add-task-to-template-btn'),
            processFilter: document.getElementById('process-filter'),
            userMenuBtn: document.getElementById('user-menu-btn'),
            userName: document.getElementById('user-name'),
            refreshBtn: document.getElementById('refresh-btn'),
            currentDate: document.getElementById('current-date'),
            currentWeekday: document.getElementById('current-weekday'),
            processSearch: document.getElementById('process-search'),
            templateFilters: document.getElementById('template-filters')
        };

        // 初始化日期显示
        function initDateDisplay() {
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth() + 1;
            const day = now.getDate();
            const weekdays = ['星期日', '星期一', '星期二', '星期三', '星期四', '星期五', '星期六'];
            const weekday = weekdays[now.getDay()];
            
            elements.currentDate.textContent = `${year}年${month}月${day}日`;
            elements.currentWeekday.textContent = weekday;
        }

        // 生成今天的任务列表（基于模板）
        function generateTodayTasks() {
            appData.todayTasks = appData.taskTemplates.map(template => {
                return {
                    ...template,
                    status: "未完成", // 未完成, 已完成, 已逾期, 逾期完成
                    actualCompletionTime: null,
                    completionNotes: ""
                };
            });
        }

        // 渲染工序列表
        function renderProcessList() {
            elements.processList.innerHTML = "";
            
            if (appData.processes.length === 0) {
                elements.processList.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fa fa-folder-open-o text-3xl mb-2"></i>
                        <p>暂无工序数据，请添加工序</p>
                    </div>
                `;
                return;
            }
            
            appData.processes.forEach(process => {
                const processEl = document.createElement('div');
                processEl.className = 'flex justify-between items-center p-3 border border-gray-200 rounded-lg';
                processEl.innerHTML = `
                    <div>
                        <h3 class="font-medium text-gray-800">${process.name}</h3>
                        <p class="text-sm text-gray-500">负责人: ${process.负责人} (${process.企业微信账号})</p>
                    </div>
                    <div class="flex gap-2">
                        <button class="edit-process p-2 text-gray-500 hover:text-primary" data-id="${process.id}">
                            <i class="fa fa-pencil"></i>
                        </button>
                        <button class="delete-process p-2 text-gray-500 hover:text-danger" data-id="${process.id}">
                            <i class="fa fa-trash"></i>
                        </button>
                    </div>
                `;
                elements.processList.appendChild(processEl);
            });
            
            // 添加事件监听
            document.querySelectorAll('.edit-process').forEach(btn => {
                btn.addEventListener('click', () => editProcess(btn.dataset.id));
            });
            
            document.querySelectorAll('.delete-process').forEach(btn => {
                btn.addEventListener('click', () => deleteProcess(btn.dataset.id));
            });
        }

        // 渲染任务模板列表
        function renderTemplateTaskList() {
            elements.templateTaskList.innerHTML = "";
            
            if (appData.taskTemplates.length === 0) {
                elements.templateTaskList.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fa fa-tasks text-3xl mb-2"></i>
                        <p>暂无任务模板，请添加任务</p>
                    </div>
                `;
                return;
            }
            
            appData.taskTemplates.forEach(task => {
                const taskEl = document.createElement('div');
                taskEl.className = 'task-card';
                taskEl.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <span class="px-2 py-1 bg-primary/10 text-primary text-xs rounded-full">${task.processName}</span>
                        <div class="flex gap-2">
                            <button class="edit-template-task p-1 text-gray-500 hover:text-primary" data-id="${task.id}">
                                <i class="fa fa-pencil"></i>
                            </button>
                            <button class="delete-template-task p-1 text-gray-500 hover:text-danger" data-id="${task.id}">
                                <i class="fa fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <h3 class="font-medium text-gray-800 mb-2">${task.content}</h3>
                    <div class="flex flex-wrap gap-4 text-sm">
                        <div class="flex items-center text-gray-600">
                            <i class="fa fa-user-o mr-1 text-gray-400"></i>
                            <span>${task.assignee} (${task.assigneeWechat})</span>
                        </div>
                        <div class="flex items-center text-gray-600">
                            <i class="fa fa-clock-o mr-1 text-gray-400"></i>
                            <span>截止: ${task.deadline}</span>
                        </div>
                        <div class="flex items-center text-gray-600">
                            <i class="fa fa-bell-o mr-1 text-gray-400"></i>
                            <span>提醒: ${task.reminderTime}</span>
                        </div>
                    </div>
                `;
                elements.templateTaskList.appendChild(taskEl);
            });
            
            // 添加事件监听
            document.querySelectorAll('.edit-template-task').forEach(btn => {
                btn.addEventListener('click', () => editTemplateTask(btn.dataset.id));
            });
            
            document.querySelectorAll('.delete-template-task').forEach(btn => {
                btn.addEventListener('click', () => deleteTemplateTask(btn.dataset.id));
            });
        }

        // 渲染班组长任务列表
        function renderLeaderTaskList() {
            elements.leaderTaskList.innerHTML = "";
            
            const selectedProcess = elements.processFilter.value;
            let filteredTasks = appData.todayTasks;
            
            if (selectedProcess !== 'all') {
                filteredTasks = appData.todayTasks.filter(task => task.processId.toString() === selectedProcess);
            }
            
            if (filteredTasks.length === 0) {
                elements.leaderTaskList.innerHTML = `
                    <div class="bg-white rounded-xl p-8 text-center card-shadow">
                        <i class="fa fa-inbox text-4xl text-gray-300 mb-3"></i>
                        <p class="text-gray-500">没有找到相关任务</p>
                    </div>
                `;
                return;
            }
            
            filteredTasks.forEach(task => {
                // 确定任务状态样式和文本
                let statusClass = "";
                let statusText = "";
                
                switch(task.status) {
                    case "未完成":
                        statusClass = "bg-warning/10 text-warning";
                        statusText = "未完成";
                        break;
                    case "已完成":
                        statusClass = "bg-success/10 text-success";
                        statusText = "已完成";
                        break;
                    case "已逾期":
                        statusClass = "bg-danger/10 text-danger";
                        statusText = "已逾期";
                        break;
                    case "逾期完成":
                        statusClass = "bg-orange-100 text-orange-600";
                        statusText = "逾期完成";
                        break;
                }
                
                const taskEl = document.createElement('div');
                taskEl.className = 'task-card';
                taskEl.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <span class="px-2 py-1 bg-primary/10 text-primary text-xs rounded-full">${task.processName}</span>
                        <span class="px-2 py-1 ${statusClass} text-xs rounded-full">${statusText}</span>
                    </div>
                    <h3 class="font-medium text-gray-800 mb-2">${task.content}</h3>
                    <div class="flex flex-wrap gap-4 text-sm mb-4">
                        <div class="flex items-center text-gray-600">
                            <i class="fa fa-clock-o mr-1 text-gray-400"></i>
                            <span>截止: ${task.deadline}</span>
                        </div>
                    </div>
                    
                    ${task.status === "已完成" || task.status === "逾期完成" ? `
                        <div class="p-3 bg-gray-50 rounded-md text-sm">
                            <p class="text-gray-600 mb-1">完成时间: ${task.actualCompletionTime || '未知'}</p>
                            ${task.completionNotes ? `<p class="text-gray-600">备注: ${task.completionNotes}</p>` : ''}
                        </div>
                    ` : ''}
                    
                    ${task.status !== "已完成" && task.status !== "逾期完成" ? `
                        <div class="mt-4">
                            <button class="complete-task-btn btn-primary w-full" data-id="${task.id}">
                                <i class="fa fa-check mr-1"></i> 标记为已完成
                            </button>
                        </div>
                    ` : ''}
                `;
                elements.leaderTaskList.appendChild(taskEl);
            });
            
            // 添加完成任务事件监听
            document.querySelectorAll('.complete-task-btn').forEach(btn => {
                btn.addEventListener('click', () => completeTask(btn.dataset.id));
            });
        }

        // 渲染工序过滤选项
        function renderProcessFilters() {
            // 清空现有选项，保留"所有工序"
            const currentValue = elements.processFilter.value;
            elements.processFilter.innerHTML = '<option value="all">所有工序</option>';
            
            // 清空模板过滤按钮
            elements.templateFilters.innerHTML = '<button class="px-3 py-1 bg-primary text-white rounded-full text-sm">全部工序</button>';
            
            appData.processes.forEach(process => {
                // 添加到班组长视图的过滤下拉
                const option = document.createElement('option');
                option.value = process.id;
                option.textContent = process.name;
                elements.processFilter.appendChild(option);
                
                // 添加到模板管理的过滤按钮
                const filterBtn = document.createElement('button');
                filterBtn.className = 'px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-sm hover:bg-gray-200';
                filterBtn.textContent = process.name;
                filterBtn.dataset.processId = process.id;
                elements.templateFilters.appendChild(filterBtn);
            });
            
            // 恢复之前的选择
            if (currentValue) {
                elements.processFilter.value = currentValue;
            }
            
            // 添加过滤事件监听
            document.querySelectorAll('#template-filters button:not(:first-child)').forEach(btn => {
                btn.addEventListener('click', () => {
                    // 重置所有按钮样式
                    document.querySelectorAll('#template-filters button').forEach(b => {
                        b.className = 'px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-sm hover:bg-gray-200';
                    });
                    // 设置当前按钮样式
                    btn.className = 'px-3 py-1 bg-primary text-white rounded-full text-sm';
                });
            });
            
            // 全部工序按钮
            document.querySelector('#template-filters button:first-child').addEventListener('click', () => {
                document.querySelectorAll('#template-filters button').forEach(b => {
                    b.className = 'px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-sm hover:bg-gray-200';
                });
                document.querySelector('#template-filters button:first-child').className = 'px-3 py-1 bg-primary text-white rounded-full text-sm';
            });
        }

        // 显示模态框
        function showModal(title, content, confirmCallback) {
            elements.modalTitle.textContent = title;
            elements.modalContent.innerHTML = content;
            elements.modal.classList.remove('hidden');
            elements.modal.classList.add('flex');
            
            // 存储确认回调
            elements.confirmModal.onclick = () => {
                if (confirmCallback && typeof confirmCallback === 'function') {
                    confirmCallback();
                }
                hideModal();
            };
        }

        // 隐藏模态框
        function hideModal() {
            elements.modal.classList.add('hidden');
            elements.modal.classList.remove('flex');
            elements.confirmModal.onclick = null;
        }

        // 添加工序
        function addProcess() {
            const modalContent = `
                <div>
                    <label class="block text-gray-700 mb-1 text-sm">工序名称</label>
                    <input type="text" id="new-process-name" class="input-field" placeholder="请输入工序名称">
                </div>
                <div>
                    <label class="block text-gray-700 mb-1 text-sm">负责人</label>
                    <input type="text" id="new-process-leader" class="input-field" placeholder="请输入负责人姓名">
                </div>
                <div>
                    <label class="block text-gray-700 mb-1 text-sm">企业微信账号（用于@提醒）</label>
                    <input type="text" id="new-process-wechat" class="input-field" placeholder="请输入负责人企业微信账号（手机号或邮箱）">
                </div>
            `;
            
            showModal('添加工序', modalContent, () => {
                const processName = document.getElementById('new-process-name').value.trim();
                const processLeader = document.getElementById('new-process-leader').value.trim();
                const processWechat = document.getElementById('new-process-wechat').value.trim();
                
                if (!processName) {
                    alert('请输入工序名称');
                    return;
                }
                
                const newProcess = {
                    id: Date.now(),
                    name: processName,
                    负责人: processLeader || '未指定',
                    企业微信账号: processWechat || ''
                };
                
                appData.processes.push(newProcess);
                renderProcessList();
                renderProcessFilters();
            });
        }

        // 编辑工序
        function editProcess(id) {
            const process = appData.processes.find(p => p.id.toString() === id);
            if (!process) return;
            
            const modalContent = `
                <input type="hidden" id="edit-process-id" value="${process.id}">
                <div>
                    <label class="block text-gray-700 mb-1 text-sm">工序名称</label>
                    <input type="text" id="edit-process-name" class="input-field" value="${process.name}">
                </div>
                <div>
                    <label class="block text-gray-700 mb-1 text-sm">负责人</label>
                    <input type="text" id="edit-process-leader" class="input-field" value="${process.负责人}">
                </div>
                <div>
                    <label class="block text-gray-700 mb-1 text-sm">企业微信账号（用于@提醒）</label>
                    <input type="text" id="edit-process-wechat" class="input-field" value="${process.企业微信账号}">
                </div>
            `;
            
            showModal('编辑工序', modalContent, () => {
                const processId = document.getElementById('edit-process-id').value;
                const processName = document.getElementById('edit-process-name').value.trim();
                const processLeader = document.getElementById('edit-process-leader').value.trim();
                const processWechat = document.getElementById('edit-process-wechat').value.trim();
                
                if (!processName) {
                    alert('请输入工序名称');
                    return;
                }
                
                const index = appData.processes.findIndex(p => p.id.toString() === processId);
                if (index !== -1) {
                    appData.processes[index].name = processName;
                    appData.processes[index].负责人 = processLeader || '未指定';
                    appData.processes[index].企业微信账号 = processWechat || '';
                    
                    // 更新任务模板中的工序信息
                    appData.taskTemplates.forEach(task => {
                        if (task.processId.toString() === processId) {
                            task.processName = processName;
                            task.assignee = processLeader || '未指定';
                            task.assigneeWechat = processWechat || '';
                        }
                    });
                    
                    renderProcessList();
                    renderTemplateTaskList();
                    renderProcessFilters();
                }
            });
        }

        // 删除工序
        function deleteProcess(id) {
            if (!confirm('确定要删除这个工序吗？相关的任务模板也会被删除。')) {
                return;
            }
            
            // 删除工序
            appData.processes = appData.processes.filter(p => p.id.toString() !== id);
            
            // 删除相关的任务模板
            appData.taskTemplates = appData.taskTemplates.filter(t => t.processId.toString() !== id);
            
            renderProcessList();
            renderTemplateTaskList();
            renderProcessFilters();
        }

        // 添加任务到模板
        function addTaskToTemplate() {
            if (appData.processes.length === 0) {
                alert('请先添加工序');
                return;
            }
            
            // 构建工序选择下拉
            let processOptions = '';
            appData.processes.forEach(process => {
                processOptions += `<option value="${process.id}">${process.name} (${process.负责人})</option>`;
            });
            
            const modalContent = `
                <div>
                    <label class="block text-gray-700 mb-1 text-sm">所属工序</label>
                    <select id="new-task-process" class="input-field">
                        ${processOptions}
                    </select>
                </div>
                <div>
                    <label class="block text-gray-700 mb-1 text-sm">任务内容</label>
                    <textarea id="new-task-content" class="input-field" rows="3" placeholder="请输入任务内容"></textarea>
                </div>
                <div>
                    <label class="block text-gray-700 mb-1 text-sm">负责人企业微信账号（用于@提醒）</label>
                    <input type="text" id="new-task-wechat" class="input-field" placeholder="请输入负责人企业微信账号">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-700 mb-1 text-sm">截止时间</label>
                        <input type="time" id="new-task-deadline" class="input-field">
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-1 text-sm">提醒时间</label>
                        <input type="time" id="new-task-reminder" class="input-field">
                    </div>
                </div>
            `;
            
            showModal('添加任务模板', modalContent, () => {
                const processId = document.getElementById('new-task-process').value;
                const taskContent = document.getElementById('new-task-content').value.trim();
                const assigneeWechat = document.getElementById('new-task-wechat').value.trim();
                const deadline = document.getElementById('new-task-deadline').value;
                const reminderTime = document.getElementById('new-task-reminder').value;
                
                if (!taskContent || !deadline) {
                    alert('请填写任务内容和截止时间');
                    return;
                }
                
                // 获取工序信息
                const process = appData.processes.find(p => p.id.toString() === processId);
                if (!process) return;
                
                const newTask = {
                    id: Date.now(),
                    processId: parseInt(processId),
                    processName: process.name,
                    content: taskContent,
                    assignee: process.负责人,
                    assigneeWechat: assigneeWechat || process.企业微信账号,
                    deadline: deadline,
                    reminderTime: reminderTime || deadline
                };
                
                appData.taskTemplates.push(newTask);
                renderTemplateTaskList();
                generateTodayTasks();
                renderLeaderTaskList();
            });
        }

        // 编辑任务模板
        function editTemplateTask(id) {
            const task = appData.taskTemplates.find(t => t.id.toString() === id);
            if (!task) return;
            
            // 构建工序选择下拉
            let processOptions = '';
            appData.processes.forEach(process => {
                const selected = process.id === task.processId ? 'selected' : '';
                processOptions += `<option value="${process.id}" ${selected}>${process.name} (${process.负责人})</option>`;
            });
            
            const modalContent = `
                <input type="hidden" id="edit-task-id" value="${task.id}">
                <div>
                    <label class="block text-gray-700 mb-1 text-sm">所属工序</label>
                    <select id="edit-task-process" class="input-field">
                        ${processOptions}
                    </select>
                </div>
                <div>
                    <label class="block text-gray-700 mb-1 text-sm">任务内容</label>
                    <textarea id="edit-task-content" class="input-field" rows="3">${task.content}</textarea>
                </div>
                <div>
                    <label class="block text-gray-700 mb-1 text-sm">负责人企业微信账号（用于@提醒）</label>
                    <input type="text" id="edit-task-wechat" class="input-field" value="${task.assigneeWechat}">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-700 mb-1 text-sm">截止时间</label>
                        <input type="time" id="edit-task-deadline" class="input-field" value="${task.deadline}">
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-1 text-sm">提醒时间</label>
                        <input type="time" id="edit-task-reminder" class="input-field" value="${task.reminderTime}">
                    </div>
                </div>
            `;
            
            showModal('编辑任务模板', modalContent, () => {
                const taskId = document.getElementById('edit-task-id').value;
                const processId = document.getElementById('edit-task-process').value;
                const taskContent = document.getElementById('edit-task-content').value.trim();
                const assigneeWechat = document.getElementById('edit-task-wechat').value.trim();
                const deadline = document.getElementById('edit-task-deadline').value;
                const reminderTime = document.getElementById('edit-task-reminder').value;
                
                if (!taskContent || !deadline) {
                    alert('请填写任务内容和截止时间');
                    return;
                }
                
                // 获取工序信息
                const process = appData.processes.find(p => p.id.toString() === processId);
                if (!process) return;
                
                const index = appData.taskTemplates.findIndex(t => t.id.toString() === taskId);
                if (index !== -1) {
                    appData.taskTemplates[index].processId = parseInt(processId);
                    appData.taskTemplates[index].processName = process.name;
                    appData.taskTemplates[index].content = taskContent;
                    appData.taskTemplates[index].assignee = process.负责人;
                    appData.taskTemplates[index].assigneeWechat = assigneeWechat || process.企业微信账号;
                    appData.taskTemplates[index].deadline = deadline;
                    appData.taskTemplates[index].reminderTime = reminderTime || deadline;
                    
                    renderTemplateTaskList();
                    generateTodayTasks();
                    renderLeaderTaskList();
                }
            });
        }

        // 删除任务模板
        function deleteTemplateTask(id) {
            if (!confirm('确定要删除这个任务模板吗？')) {
                return;
            }
            
            appData.taskTemplates = appData.taskTemplates.filter(t => t.id.toString() !== id);
            renderTemplateTaskList();
            generateTodayTasks();
            renderLeaderTaskList();
        }

        // 完成任务（支持逾期完成状态）
        function completeTask(id) {
            const task = appData.todayTasks.find(t => t.id.toString() === id);
            if (!task) return;
            
            // 检查是否已逾期
            const now = new Date();
            const currentTime = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
            const [deadlineHours, deadlineMinutes] = task.deadline.split(':').map(Number);
            const [currentHours, currentMinutes] = currentTime.split(':').map(Number);
            const isOverdue = currentHours * 60 + currentMinutes > deadlineHours * 60 + deadlineMinutes;
            
            const modalContent = `
                <input type="hidden" id="complete-task-id" value="${task.id}">
                <div>
                    <label class="block text-gray-700 mb-1 text-sm">完成备注 (可选)</label>
                    <textarea id="task-completion-notes" class="input-field" rows="3" placeholder="请输入完成情况或备注"></textarea>
                </div>
                ${isOverdue ? `
                    <div class="bg-orange-50 p-3 rounded-md text-sm text-orange-700 mt-2">
                        <i class="fa fa-exclamation-circle mr-1"></i>
                        注意：此任务已逾期，完成后将标记为"逾期完成"
                    </div>
                ` : ''}
            `;
            
            showModal(isOverdue ? '标记任务为逾期完成' : '标记任务为已完成', modalContent, () => {
                const taskId = document.getElementById('complete-task-id').value;
                const notes = document.getElementById('task-completion-notes').value.trim();
                
                const index = appData.todayTasks.findIndex(t => t.id.toString() === taskId);
                if (index !== -1) {
                    // 获取当前时间
                    const completionTime = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
                    
                    // 根据是否逾期设置状态
                    appData.todayTasks[index].status = isOverdue ? "逾期完成" : "已完成";
                    appData.todayTasks[index].actualCompletionTime = completionTime;
                    appData.todayTasks[index].completionNotes = notes;
                    
                    renderLeaderTaskList();
                }
            });
        }

        // 配置企业微信
        function configureWechat() {
            const modalContent = `
                <div>
                    <label class="block text-gray-700 mb-1 text-sm">企业微信机器人Webhook</label>
                    <input type="text" id="wechat-robot-url" class="input-field" value="${appData.wechatConfig.robotUrl}" placeholder="请输入企业微信机器人Webhook地址">
                </div>
                <div class="bg-blue-50 p-3 rounded-md text-sm text-blue-700 mt-2">
                    <i class="fa fa-info-circle mr-1"></i>
                    请在企业微信中创建机器人并获取Webhook地址，用于发送通知
                </div>
            `;
            
            showModal('企业微信配置', modalContent, () => {
                const robotUrl = document.getElementById('wechat-robot-url').value.trim();
                appData.wechatConfig.robotUrl = robotUrl;
                alert('配置已保存');
            });
        }

        // 配置任务刷新时间
        function configureRefreshTime() {
            const modalContent = `
                <div>
                    <label class="block text-gray-700 mb-1 text-sm">每日任务刷新时间</label>
                    <input type="time" id="refresh-time-input" class="input-field" value="${appData.refreshTime}">
                </div>
                <div class="bg-blue-50 p-3 rounded-md text-sm text-blue-700 mt-2">
                    <i class="fa fa-info-circle mr-1"></i>
                    系统将在每天指定时间自动刷新任务列表
                </div>
            `;
            
            showModal('设置任务刷新时间', modalContent, () => {
                const refreshTime = document.getElementById('refresh-time-input').value;
                if (refreshTime) {
                    appData.refreshTime = refreshTime;
                    alert(`任务刷新时间已设置为每天 ${refreshTime}`);
                    
                    // 重新设置定时任务
                    clearTimeout(dailyRefreshTimeout);
                    setupDailyTaskRefresh();
                } else {
                    alert('请选择有效的时间');
                }
            });
        }

        // 管理账户（添加/删除管理员和组长账户）
        function manageAccounts() {
            // 生成账户列表HTML
            let accountsHtml = '<div class="space-y-2 max-h-40 overflow-y-auto">';
            appData.accounts.forEach(account => {
                accountsHtml += `
                    <div class="flex justify-between items-center p-2 border border-gray-200 rounded">
                        <div>
                            <span class="font-medium">${account.username}</span>
                            <span class="ml-2 px-2 py-0.5 bg-${account.role === 'admin' ? 'primary' : 'secondary'}/10 text-${account.role === 'admin' ? 'primary' : 'secondary'} text-xs rounded">
                                ${account.role === 'admin' ? '管理员' : '班组长'}
                            </span>
                        </div>
                        <button class="delete-account text-danger" data-username="${account.username}">
                            <i class="fa fa-trash"></i>
                        </button>
                    </div>
                `;
            });
            accountsHtml += '</div>';
            
            const modalContent = `
                ${accountsHtml}
                <div class="pt-3 border-t border-gray-200 mt-3">
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-gray-700 mb-1 text-sm">用户名</label>
                            <input type="text" id="new-account-username" class="input-field" placeholder="输入新用户名">
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-1 text-sm">角色</label>
                            <select id="new-account-role" class="input-field">
                                <option value="admin">管理员</option>
                                <option value="leader">班组长</option>
                            </select>
                        </div>
                    </div>
                    <button id="add-account-btn" class="btn-primary w-full mt-3">
                        <i class="fa fa-plus mr-1"></i> 添加账户
                    </button>
                </div>
            `;
            
            showModal('账户管理', modalContent, () => {
                // 确认按钮不做处理，添加账户通过单独的按钮
            });
            
            // 添加账户事件
            document.getElementById('add-account-btn').addEventListener('click', () => {
                const username = document.getElementById('new-account-username').value.trim();
                const role = document.getElementById('new-account-role').value;
                
                if (!username) {
                    alert('请输入用户名');
                    return;
                }
                
                // 检查用户名是否已存在
                const exists = appData.accounts.some(acc => acc.username === username);
                if (exists) {
                    alert('该用户名已存在');
                    return;
                }
                
                appData.accounts.push({ username, role });
                manageAccounts(); // 刷新账户列表
            });
            
            // 删除账户事件
            document.querySelectorAll('.delete-account').forEach(btn => {
                btn.addEventListener('click', () => {
                    const username = btn.dataset.username;
                    
                    // 不能删除当前登录用户
                    if (appData.currentUser && appData.currentUser.username === username) {
                        alert('不能删除当前登录的账户');
                        return;
                    }
                    
                    // 至少保留一个管理员账户
                    const adminAccounts = appData.accounts.filter(acc => acc.role === 'admin');
                    if (adminAccounts.length <= 1 && adminAccounts[0].username === username) {
                        alert('至少需要保留一个管理员账户');
                        return;
                    }
                    
                    appData.accounts = appData.accounts.filter(acc => acc.username !== username);
                    manageAccounts(); // 刷新账户列表
                });
            });
        }

        // 下载文件工具函数（通用）
function downloadFile(content, filename, contentType) {
    const blob = new Blob([content], { type: contentType });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    setTimeout(() => {
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }, 0);
}

// 导出为Excel文件（.xlsx）
function exportToExcel() {
    // 准备导出数据
    const exportData = appData.todayTasks.map(task => ({
        日期: new Date().toLocaleDateString(),
        工序: task.processName,
        任务内容: task.content,
        负责人: task.assignee,
        截止时间: task.deadline,
        提醒时间: task.reminderTime,
        状态: task.status,
        完成时间: task.actualCompletionTime || '未完成'
    }));

    if (exportData.length === 0) {
        alert('没有可导出的数据');
        return;
    }

    // 创建工作簿和工作表
    const workbook = XLSX.utils.book_new();
    // 将数据转换为工作表（header参数指定表头）
    const worksheet = XLSX.utils.json_to_sheet(exportData, { 
        header: ['日期', '工序', '任务内容', '负责人', '截止时间', '提醒时间', '状态', '完成时间'] 
    });

    // 将工作表添加到工作簿
    XLSX.utils.book_append_sheet(workbook, worksheet, '任务数据');

    // 生成Excel文件的二进制数据
    const excelData = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });

    // 下载文件
    downloadFile(
        excelData, 
        `任务数据_${new Date().toLocaleDateString().replace(/\//g, '-')}.xlsx`, 
        'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
    );
}

// 显示导出模态框（增加Excel选项）
function showExportModal() {
    const modalContent = `
        <div>
            <label class="block text-gray-700 mb-2 text-sm">选择导出范围</label>
            <div class="space-y-2">
                <label class="flex items-center">
                    <input type="radio" name="export-range" value="today" checked class="mr-2">
                    <span>今日数据</span>
                </label>
                <label class="flex items-center">
                    <input type="radio" name="export-range" value="week" class="mr-2">
                    <span>本周数据</span>
                </label>
                <label class="flex items-center">
                    <input type="radio" name="export-range" value="month" class="mr-2">
                    <span>本月数据</span>
                </label>
            </div>
        </div>
        <div>
            <label class="block text-gray-700 mb-2 text-sm mt-3">选择导出格式</label>
            <div class="space-y-2">
                <label class="flex items-center">
                    <input type="radio" name="export-format" value="xlsx" checked class="mr-2">
                    <span>Excel (.xlsx)</span>
                </label>
                <label class="flex items-center">
                    <input type="radio" name="export-format" value="csv" class="mr-2">
                    <span>CSV (表格)</span>
                </label>
                <label class="flex items-center">
                    <input type="radio" name="export-format" value="json" class="mr-2">
                    <span>JSON (数据格式)</span>
                </label>
            </div>
        </div>
    `;
    
    // 显示模态框，根据选择的格式导出
    showModal('导出数据', modalContent, () => {
        const format = document.querySelector('input[name="export-format"]:checked').value;
        if (format === 'xlsx') {
            exportToExcel(); // 导出Excel
        } else if (format === 'csv') {
            exportToCSV(); // 导出CSV（沿用之前的函数）
        } else if (format === 'json') {
            exportToJSON(); // 导出JSON（沿用之前的函数）
        }
    });
}

// 导出为CSV（保留原功能）
function exportToCSV() {
    const exportData = appData.todayTasks.map(task => ({
        日期: new Date().toLocaleDateString(),
        工序: task.processName,
        任务内容: task.content,
        负责人: task.assignee,
        截止时间: task.deadline,
        提醒时间: task.reminderTime,
        状态: task.status,
        完成时间: task.actualCompletionTime || '未完成'
    }));

    if (exportData.length === 0) {
        alert('没有可导出的数据');
        return;
    }

    const headers = Object.keys(exportData[0]).join(',') + '\n';
    const rows = exportData.map(item => 
        Object.values(item).map(value => 
            value.toString().includes(',') ? `"${value}"` : value
        ).join(',')
    ).join('\n');
    
    downloadFile(headers + rows, `任务数据_${new Date().toLocaleDateString().replace(/\//g, '-')}.csv`, 'text/csv');
}

// 导出为JSON（保留原功能）
function exportToJSON() {
    const exportData = appData.todayTasks.map(task => ({
        日期: new Date().toLocaleDateString(),
        工序: task.processName,
        任务内容: task.content,
        负责人: task.assignee,
        截止时间: task.deadline,
        提醒时间: task.reminderTime,
        状态: task.status,
        完成时间: task.actualCompletionTime || '未完成'
    }));

    if (exportData.length === 0) {
        alert('没有可导出的数据');
        return;
    }

    const jsonContent = JSON.stringify(exportData, null, 2);
    downloadFile(jsonContent, `任务数据_${new Date().toLocaleDateString().replace(/\//g, '-')}.json`, 'application/json');
}

// 修改导出按钮的事件绑定（在initEventListeners中）
elements.exportDataBtn.addEventListener('click', showExportModal);

        // 登录处理（无密码）
        function handleLogin() {
            const username = elements.usernameInput.value.trim();
            
            if (!username) {
                alert('请输入用户名');
                return;
            }
            
            // 查找账户
            const account = appData.accounts.find(acc => acc.username === username);
            if (!account) {
                alert('账户不存在，请联系管理员添加');
                return;
            }
            
            // 登录成功
            appData.currentUser = account;
            
            elements.userName.textContent = username;
            elements.loginPage.classList.add('hidden');
            elements.mainPage.classList.remove('hidden');
            
            // 根据角色显示不同的默认视图
            if (appData.currentUser.role === 'admin') {
                elements.adminView.classList.remove('hidden');
                elements.leaderView.classList.add('hidden');
                elements.adminTab.classList.add('text-primary', 'border-primary', 'border-b-2');
                elements.leaderTab.classList.remove('text-primary', 'border-primary', 'border-b-2');
                elements.leaderTab.classList.add('text-gray-500');
            } else {
                elements.adminView.classList.add('hidden');
                elements.leaderView.classList.remove('hidden');
                elements.leaderTab.classList.add('text-primary', 'border-primary', 'border-b-2');
                elements.adminTab.classList.remove('text-primary', 'border-primary', 'border-b-2');
                elements.adminTab.classList.add('text-gray-500');
            }
            
            // 初始化数据
            generateTodayTasks();
            renderLeaderTaskList();
        }

        // ------------------------------
        // 企业微信通知相关功能（带@功能）
        // ------------------------------

        // 发送企业微信通知（修复@功能和跨域问题）
function sendWechatNotification(message, mentionedUsers = []) {
    // 检查是否配置了企业微信机器人Webhook
    if (!appData.wechatConfig.robotUrl) {
        alert('未配置企业微信机器人，请先在设置中填写Webhook地址');
        return;
    }

    // 处理企业微信@格式：手机号需要加@前缀，邮箱则不需要
    const formattedMentionedUsers = mentionedUsers.map(user => {
        // 判断是否为手机号（11位数字）
        if (/^\d{11}$/.test(user)) {
            return `@${user}`; // 手机号必须加@
        }
        return user; // 邮箱直接使用
    });

    // 企业微信机器人API要求的消息格式
    const payload = {
        msgtype: "text",
        text: {
            content: message, // 通知内容
            mentioned_list: formattedMentionedUsers // 格式化后的@用户列表
        }
    };

    // 调用企业微信机器人API发送通知（处理跨域问题）
    fetch(appData.wechatConfig.robotUrl, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(payload),
        mode: 'cors' // 允许跨域请求
    })
    .then(response => {
        if (response.ok) {
            console.log('通知发送成功');
            return response.json();
        } else {
            console.error('通知发送失败，HTTP状态码：', response.status);
            response.text().then(text => console.error('错误详情：', text));
            alert('通知发送失败，请检查Webhook地址是否正确');
        }
    })
    .catch(error => {
        console.error('发送通知时出错：', error);
        alert('发送通知失败，可能是浏览器安全限制，请在服务器环境下使用');
    });
}

        // 定时任务变量（用于取消和重新设置）
        let dailyRefreshTimeout;

        // 每天指定时间自动刷新任务并发送通知
        function setupDailyTaskRefresh() {
            const now = new Date();
            let [targetHours, targetMinutes] = appData.refreshTime.split(':').map(Number);
            
            let targetTime = new Date();
            targetTime.setHours(targetHours, targetMinutes, 0, 0); // 设置目标时间为当天的指定时间

            // 如果今天的指定时间已经过了，就设置为明天的指定时间
            if (now > targetTime) {
                targetTime.setDate(targetTime.getDate() + 1);
            }

            // 计算当前时间到目标时间的毫秒数
            const timeDiff = targetTime - now;
            console.log(`下次任务刷新时间: ${targetTime.toLocaleString()}`);

            // 设置定时任务
            dailyRefreshTimeout = setTimeout(() => {
                // 1. 刷新今日任务（基于模板重新生成）
                generateTodayTasks();
                renderLeaderTaskList();

                // 2. 发送每日任务刷新通知
                sendWechatNotification(`【每日任务更新】今日任务已在${appData.refreshTime}自动刷新，请各位班组长查收并开始处理。`);

                // 3. 再次设置明天的定时任务（循环执行）
                setupDailyTaskRefresh();
            }, timeDiff);
        }

        // 初始化事件监听
        function initEventListeners() {
            // 登录按钮
            elements.loginBtn.addEventListener('click', handleLogin);
            
            // 账户管理
            elements.manageAccountsBtn.addEventListener('click', manageAccounts);
            
            // 角色切换
            elements.adminTab.addEventListener('click', () => {
                // 只有管理员可以切换到管理员视图
                if (appData.currentUser && appData.currentUser.role === 'admin') {
                    elements.adminView.classList.remove('hidden');
                    elements.leaderView.classList.add('hidden');
                    elements.adminTab.classList.add('text-primary', 'border-primary', 'border-b-2');
                    elements.leaderTab.classList.remove('text-primary', 'border-primary', 'border-b-2');
                    elements.leaderTab.classList.add('text-gray-500');
                } else {
                    alert('只有管理员可以访问此视图');
                }
            });
            
            elements.leaderTab.addEventListener('click', () => {
                elements.adminView.classList.add('hidden');
                elements.leaderView.classList.remove('hidden');
                elements.leaderTab.classList.add('text-primary', 'border-primary', 'border-b-2');
                elements.adminTab.classList.remove('text-primary', 'border-primary', 'border-b-2');
                elements.adminTab.classList.add('text-gray-500');
            });
            
            // 模态框控制
            elements.closeModal.addEventListener('click', hideModal);
            elements.cancelModal.addEventListener('click', hideModal);
            
            // 工序管理
            elements.addProcessBtn.addEventListener('click', addProcess);
            
            // 任务模板管理
            elements.addTaskToTemplateBtn.addEventListener('click', addTaskToTemplate);
            
            // 企业微信配置
            elements.wechatConfigBtn.addEventListener('click', configureWechat);
            
            // 刷新时间配置
            elements.refreshTimeConfigBtn.addEventListener('click', configureRefreshTime);
            
            // 导出数据
            elements.exportDataBtn.addEventListener('click', showExportModal);
            
            // 过滤任务
            elements.processFilter.addEventListener('change', renderLeaderTaskList);
            
            // 刷新按钮
            elements.refreshBtn.addEventListener('click', () => {
                generateTodayTasks();
                renderLeaderTaskList();
                renderTemplateTaskList();
                
                // 显示刷新提示
                const toast = document.createElement('div');
                toast.className = 'fixed top-4 right-4 bg-success text-white px-4 py-2 rounded-md shadow-lg z-50';
                toast.textContent = '数据已刷新';
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    toast.classList.add('opacity-0', 'transition-opacity', 'duration-500');
                    setTimeout(() => {
                        document.body.removeChild(toast);
                    }, 500);
                }, 2000);
            });
            
            // 搜索工序
            elements.processSearch.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const filteredProcesses = appData.processes.filter(p => 
                    p.name.toLowerCase().includes(searchTerm) || 
                    p.负责人.toLowerCase().includes(searchTerm)
                );
                
                // 临时替换并渲染
                const originalProcesses = appData.processes;
                appData.processes = filteredProcesses;
                renderProcessList();
                appData.processes = originalProcesses;
            });
            
            // 按回车键登录
            elements.usernameInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleLogin();
                }
            });
        }

        // 初始化应用
        function initApp() {
            initDateDisplay();
            renderProcessList();
            renderTemplateTaskList();
            renderProcessFilters();
            initEventListeners();
            
            // 启动通知检查（每分钟一次）
            setInterval(checkTaskNotifications, 60 * 1000);
            
            // 启动每日任务刷新定时器
            setupDailyTaskRefresh();
            
            console.log('系统初始化完成');
        }

        // 启动应用
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>